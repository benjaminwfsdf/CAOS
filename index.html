<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <meta name="format-detection" content="telephone=no, date=no, address=no, email=no, url=no">
  <title>CAOS - Est√©tica Panel</title>

  <!-- Fuentes -->
  <link href="https://fonts.googleapis.com/css2?family=Rock+Salt&family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0b0b0c">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CAOS">

  <!-- Tus estilos base (si los usas en otros m√≥dulos) -->
  <link rel="stylesheet" href="style-caos.css">
  <link rel="stylesheet" href="style-caos-legible.css">

  <style>
    :root{
      --ink:#000;
      --paper:#fff;
      --shadow:8px 8px 0 var(--ink);
      --radius:18px;
      --pad:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      padding:env(safe-area-inset-top) 12px calc(16px + env(safe-area-inset-bottom)) 12px;
      background:var(--paper);
      color:var(--ink);
      background-image:repeating-linear-gradient(45deg,var(--ink) 0px,var(--ink) 1px,transparent 1px,transparent 6px);
      background-attachment:fixed;
      font-family:'Rock Salt',cursive;
      -webkit-tap-highlight-color:transparent;
    }

    /* Shell tipo app */
    .panel{
      max-width:900px; margin:14px auto;
      background:var(--paper);
      border:3px solid var(--ink);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:var(--pad);
      position:relative; /* globos */
    }
    .titulo{
      font-size:clamp(24px,7vw,36px);
      font-weight:700;
      text-align:center;
      border:3px dashed var(--ink);
      border-radius:14px;
      padding:12px;
      margin:0 0 6px 0;
      background:var(--paper);
      clip-path: polygon(0 0, 90% 0, 100% 10%, 100% 90%, 90% 100%, 0 100%);
    }
    .subtitulo{
      text-align:center;
      font-size:clamp(14px,3.8vw,18px);
      font-weight:700;
      margin:2px 0 12px 0;
      letter-spacing:.5px;
    }

    .bloque{
      border:2px solid var(--ink);
      border-radius:14px;
      box-shadow:5px 5px 0 var(--ink);
      padding:14px;
      background:var(--paper);
      margin-bottom:14px;
    }

    /* Fila adaptable */
    .fila{
      display:flex; flex-wrap:wrap; gap:12px; align-items:center;
      margin:10px 0;
    }
    .fila > label, .fila > a, .fila > button, .fila > input, .fila > span{
      flex:1 1 100%;
    }

    /* Controles t√°ctiles */
    label, select, button, input{ font-family:inherit; font-size:16px }
    select, button, input[type="text"]{
      width:100%;
      min-height:48px;
      border:2px solid var(--ink);
      border-radius:12px;
      background:var(--paper);
      padding:12px 14px;
      box-shadow:3px 3px 0 var(--ink);
      color:var(--ink);
    }
    input#buscarAlumno{ font-family:'Comic Neue', cursive; }

    /* Botones de acci√≥n tipo ‚Äúllamada‚Äù */
    .autorizar{
      display:block; width:100%;
      text-align:center; text-decoration:none; text-transform:uppercase;
      border:3px solid var(--ink); border-radius:14px;
      box-shadow:4px 4px 0 var(--ink);
      background:var(--paper); color:var(--ink);
      font-family:'Rock Salt', cursive;
      font-weight:700; letter-spacing:1px;
      padding:14px; min-height:48px; font-size:16px;
      margin-top:10px;
    }

    /* Etiquetas peque√±as legibles */
    small.muted{
      color:#222; opacity:.85; font-family:Arial, sans-serif;
      display:block; margin-top:6px;
    }

    /* Layout sensible */
    @media (min-width:720px){
      .fila--dos > *{ flex:1 1 calc(50% - 12px) }
    }

    /* Footer */
    footer{
      max-width:700px; margin:10px auto 18px; padding:12px;
      background:var(--paper);
      border:3px solid var(--ink); border-radius:14px;
      box-shadow:4px 4px 0 var(--ink);
      text-align:center; font:700 12px/1.3 Arial, sans-serif;
    }

    /* Accesibilidad */
    button:focus-visible, a:focus-visible, select:focus-visible, input:focus-visible{
      outline:3px dashed var(--ink); outline-offset:2px;
    }
    html, body{max-width:100%; overflow-x:hidden}

    /* Globos (igual que los tuyos) */
    .caos-relative{position:relative}
    .bubble{
      position:absolute; z-index:999; max-width:320px; background:#fff; color:#000;
      border:3px solid #000; box-shadow:6px 6px 0 #000; padding:12px 14px; font-weight:700; line-height:1.2;
      border-radius:14px; transform:translate(-50%,-110%) scale(0.98); opacity:0; pointer-events:none;
      animation:bubble-in 250ms ease-out forwards, bubble-out 3s 2.4s ease-in forwards;
    }
    .bubble::after{
      content:""; position:absolute; bottom:-18px; left:50%; transform:translateX(-50%) rotate(8deg);
      width:24px; height:24px; background:#fff; border-left:3px solid #000; border-bottom:3px solid #000;
      box-shadow:6px 6px 0 #000; clip-path:polygon(0 0,100% 0,100% 100%);
    }
    .bubble--ok{ border-color:#09b37a; box-shadow:6px 6px 0 #09b37a }
    .bubble--warn{ border-color:#f59e0b; box-shadow:6px 6px 0 #f59e0b }
    .bubble--error{ border-color:#e02424; box-shadow:6px 6px 0 #e02424 }
    @keyframes bubble-in{ to{ opacity:1; transform:translate(-50%,-110%) scale(1)} }
    @keyframes bubble-out{ to{ opacity:0; transform:translate(-50%,-130%) scale(0.96)} }

    .onomato{
      position:absolute; z-index:998; font-weight:900; letter-spacing:2px; font-size:28px; color:#33e6a4;
      -webkit-text-stroke:2px #000; text-shadow:6px 6px 0 #09b37a;
      transform:translate(-50%,-50%) scale(0.6) rotate(-6deg); opacity:0; pointer-events:none;
      animation:ono-pop 520ms ease-out forwards;
    }
    .onomato--error{ color:#ff6b6b; text-shadow:6px 6px 0 #e02424 }
    .onomato--wow{ color:#ffd45a; text-shadow:6px 6px 0 #f59e0b }
    @keyframes ono-pop{
      20%{ opacity:1; transform:translate(-50%,-50%) scale(1.1) rotate(2deg) }
      60%{ transform:translate(-50%,-54%) scale(1) rotate(-2deg) }
      100%{ opacity:0; transform:translate(-50%,-60%) scale(0.9) rotate(0deg) }
    }
  </style>
</head>
<body>
  <main class="panel caos-relative">
    <h1 class="titulo">CAOS</h1>
    <p class="subtitulo">(CARTAS ANTI ORDEN EN LA SALA)</p>

    <!-- Bloque cursos -->
    <section class="bloque">
      <div class="fila fila--dos">
        <label>Curso:
          <select id="cursoSelect">
            <option>Selecciona un curso</option>
          </select>
        </label>
        <button id="btnEditarEstudiantes">üì• Cargar estudiantes</button>
        <button id="btnEditarCursosCargo">‚úèÔ∏è Editar cursos a cargo</button>
      </div>
      <small class="muted" id="statusCursos"></small>
    </section>

    <!-- Bloque alumnos -->
    <section class="bloque">
      <div class="fila fila--dos">
        <label style="flex:1 1 260px">Alumno:
          <select id="alumnoSelect" style="min-width:220px;">
            <option>Selecciona un estudiante</option>
          </select>
        </label>
        <input id="buscarAlumno" type="text" inputmode="search" placeholder="Buscar alumno‚Ä¶">
      </div>

      <div class="fila">
        <span aria-hidden="true">////////////////</span>
        <a id="btnAleatoria" href="#">
          <button id="btnAleatoriaInner" disabled>Asignar carta aleatoria</button>
        </a>
      </div>
      <div class="fila">
        <span aria-hidden="true">////////////////</span>
        <a id="btnEspecifica" href="#">
          <button id="btnEspecificaInner" disabled>Asignar carta espec√≠fica</button>
        </a>
      </div>
      <small class="muted" id="statusAlumnos"></small>
    </section>

    <a id="btnAutorizar" href="#" class="autorizar">Autorizar uso</a>

    <div style="text-align:center; margin-top:12px">
      <button id="btnCierreAno" class="autorizar" style="max-width:320px; margin:0 auto;">
        Cierre de A√±o Escolar
      </button>
    </div>
  </main>

  <footer>
    ¬© 2025 CAOS. Todos los derechos reservados. ‚Äî Sitio desarrollado por Benjam√≠n Gonz√°lez.
  </footer>

  <script>
    // === Globos / onomatopeyas (igual que ten√≠as) ===
    function showBubble(anchorEl, texto, tipo='ok'){
      const panel = anchorEl.closest('.caos-relative') || document.body;
      const rect = anchorEl.getBoundingClientRect();
      const parentRect = panel.getBoundingClientRect();
      const b = document.createElement('div');
      b.className = `bubble bubble--${tipo}`;
      b.setAttribute('role','status'); b.setAttribute('aria-live','polite');
      b.textContent = texto;
      b.style.left = (rect.left - parentRect.left + rect.width/2) + 'px';
      b.style.top  = (rect.top  - parentRect.top) + 'px';
      panel.appendChild(b);
      setTimeout(()=> b.remove(), 3200);
    }
    function showOnomato(anchorEl, texto='¬°POW!', estilo='ok'){
      const panel = anchorEl.closest('.caos-relative') || document.body;
      const rect = anchorEl.getBoundingClientRect();
      const parentRect = panel.getBoundingClientRect();
      const o = document.createElement('div');
      o.className = `onomato onomato--${estilo}`;
      o.textContent = texto;
      o.style.left = (rect.left - parentRect.left + rect.width/2) + 'px';
      o.style.top  = (rect.top  - parentRect.top - 30) + 'px';
      panel.appendChild(o);
      setTimeout(()=> o.remove(), 600);
    }

    // === Par√°metros / rutas (sin cambios) ===
    const usuario = new URLSearchParams(window.location.search).get("usuario");
    if (!usuario) { window.location.href = "login.html"; }
    const apiUrl = "https://script.google.com/macros/s/AKfycbwkdGN5y_wtAQTfxhzQmkpazwdfx_RrYAOwJtm3S4RdFCqnROdrKVMygzhd1ai_lTifRQ/exec";

    // === Refs ===
    const cursoSelect = document.getElementById('cursoSelect');
    const alumnoSelect = document.getElementById('alumnoSelect');
    const buscarAlumno = document.getElementById('buscarAlumno');
    const btnAleatoria = document.getElementById('btnAleatoria');
    const btnEspecifica = document.getElementById('btnEspecifica');
    const btnAleatoriaInner = document.getElementById('btnAleatoriaInner');
    const btnEspecificaInner = document.getElementById('btnEspecificaInner');
    const btnAutorizar = document.getElementById('btnAutorizar');
    const btnEditarEstudiantes = document.getElementById('btnEditarEstudiantes');
    const btnEditarCursosCargo = document.getElementById('btnEditarCursosCargo');
    const btnCierreAno = document.getElementById('btnCierreAno');
    const statusCursos = document.getElementById('statusCursos');
    const statusAlumnos = document.getElementById('statusAlumnos');

    // Navegaci√≥n fija (igual)
    btnAutorizar.href = `panel_profesor/validar_canje_CAOS.html?usuario=${encodeURIComponent(usuario)}`;
    btnEditarEstudiantes.onclick = () => location.href = `panel_profesor/cargar_excel_estudiantes.html?usuario=${encodeURIComponent(usuario)}`;
    btnEditarCursosCargo.onclick = () => location.href = `panel_profesor/editar_cursos.html?usuario=${encodeURIComponent(usuario)}`;
    btnCierreAno.onclick = () => location.href = `panel_profesor/cierre_ano_escolar.html?usuario=${encodeURIComponent(usuario)}`;

    // Cach√© local (5 min)
    const TTL = 5 * 60 * 1000;
    const now = () => Date.now();
    function getCache(key){
      try{ const raw = localStorage.getItem(key); if(!raw) return null;
        const o = JSON.parse(raw); if(!o || !o.ts || !o.data) return null;
        if((now()-o.ts)>TTL) return null; return o.data;
      }catch{ return null }
    }
    function setCache(key,data){ try{ localStorage.setItem(key, JSON.stringify({ts:now(), data})) }catch{} }

    let cursosCtrl=null, alumnosCtrl=null;

    // Cursos con SWR
    async function cargarCursos(){
      const cacheKey=`cursos:${usuario}`;
      const cached=getCache(cacheKey);
      if(cached && Array.isArray(cached)){
        pintarCursos(cached); statusCursos.textContent="Cursos (cach√©, actualizando‚Ä¶)"; fetchCursos(true);
      }else{
        statusCursos.textContent="Cargando cursos‚Ä¶"; await fetchCursos(false);
      }
      async function fetchCursos(background){
        if(cursosCtrl) cursosCtrl.abort();
        cursosCtrl=new AbortController();
        try{
          const r=await fetch(`${apiUrl}?accion=obtener_cursos_profesor&usuario=${encodeURIComponent(usuario)}`,{signal:cursosCtrl.signal});
          const data=await r.json();
          if(data.ok){
            setCache(cacheKey,data.cursos||[]);
            pintarCursos(data.cursos||[]);
            statusCursos.textContent=background?"Cursos actualizados.":"Cursos listos.";
            if(!background){ showOnomato(cursoSelect,'¬°POW!','ok'); showBubble(cursoSelect,'‚úÖ Cursos cargados','ok'); }
          }else if(!background){
            statusCursos.textContent="Error al cargar cursos."; showOnomato(cursoSelect,'¬°BANG!','error'); showBubble(cursoSelect,'‚ùå Error al cargar cursos','error');
          }
        }catch(e){
          if(!background){ statusCursos.textContent="Error de red al cargar cursos."; showOnomato(cursoSelect,'¬°BANG!','error'); showBubble(cursoSelect,'‚ùå Error de red','error'); }
        }
      }
    }
    function pintarCursos(cursos){
      cursoSelect.innerHTML='<option>Selecciona un curso</option>';
      const sufijos=["ro","do","ro","to","to","to","mo","vo"]; // 1ro..8vo B√°sico
      const medios=["1ro","2do","3ro","4to","5to"];            // AHORA soporta hasta 5¬∞ Medio
      (cursos||[]).forEach(raw=>{
        let label="";
        const m=raw.match(/^(\d+)(?:¬∫|¬∞|\s)?\s?(B√°sico|Medio)\s([ABC])$/i);
        if(m){
          const grado=parseInt(m[1],10); const nivel=m[2]; const letra=m[3].toUpperCase();
          if(nivel.toLowerCase()==="b√°sico" || nivel.toLowerCase()==="basico"){
            // 1..8 con sufijo; si est√° fuera de rango, fallback gen√©rico
            label = (grado>=1 && grado<=8)
              ? `${grado}${sufijos[grado-1]} B√°sico ${letra}`
              : `${grado}¬∞ B√°sico ${letra}`;
          }else{
            // Medio 1..5 con array; fuera de rango, fallback gen√©rico
            label = (grado>=1 && grado<=medios.length)
              ? `${medios[grado-1]} Medio ${letra}`
              : `${grado}¬∞ Medio ${letra}`;
          }
        }else{
          label=raw;
        }
        const opt=document.createElement('option'); opt.value=raw; opt.textContent=label; cursoSelect.appendChild(opt);
      });
    }

    // Alumnos + b√∫squeda local
    async function cargarAlumnos(curso){
      const cacheKey=`alumnos:${curso}`;
      const cached=getCache(cacheKey);
      if(cached && Array.isArray(cached)){
        pintarAlumnos(cached); statusAlumnos.textContent="Alumnos (cach√©, actualizando‚Ä¶)"; fetchAlumnos(curso,true);
      }else{
        statusAlumnos.textContent="Cargando alumnos‚Ä¶"; await fetchAlumnos(curso,false);
      }
      async function fetchAlumnos(curso,background){
        if(alumnosCtrl) alumnosCtrl.abort();
        alumnosCtrl=new AbortController();
        try{
          const r=await fetch(`${apiUrl}?accion=obtener_estudiantes&curso=${encodeURIComponent(curso)}`,{signal:alumnosCtrl.signal});
          const data=await r.json();
          if(data.ok && Array.isArray(data.estudiantes)){
            setCache(cacheKey,data.estudiantes);
            if(!buscarAlumno.value.trim()) pintarAlumnos(data.estudiantes);
            statusAlumnos.textContent=background?"Alumnos actualizados.":"Alumnos listos.";
            if(!background){ showOnomato(alumnoSelect,'¬°POW!','ok'); showBubble(alumnoSelect,'‚úÖ Alumnos cargados','ok'); }
          }else if(!background){
            statusAlumnos.textContent="Error al cargar estudiantes."; showOnomato(alumnoSelect,'¬°BANG!','error'); showBubble(alumnoSelect,'‚ùå Error al cargar estudiantes','error');
          }
        }catch(e){
          if(!background){ statusAlumnos.textContent="Error de red al cargar estudiantes."; showOnomato(alumnoSelect,'¬°BANG!','error'); showBubble(alumnoSelect,'‚ùå Error de red','error'); }
        }
      }
    }
    function pintarAlumnos(lista){
      const prev=alumnoSelect.value;
      alumnoSelect.innerHTML='<option>Selecciona un estudiante</option>';
      (lista||[]).forEach(n=>{ const o=document.createElement('option'); o.textContent=n; alumnoSelect.appendChild(o); });
      if(prev) alumnoSelect.value=prev;
      setRepartoHabilitado(false);
    }

    function setRepartoHabilitado(on){
      btnAleatoriaInner.disabled=!on; btnEspecificaInner.disabled=!on;
      if(!on){ btnAleatoria.href='#'; btnEspecifica.href='#'; }
    }

    // Eventos
    document.addEventListener('DOMContentLoaded', async ()=>{
      await cargarCursos();

      cursoSelect.addEventListener('change', ()=>{
        const curso=cursoSelect.value;
        localStorage.setItem("cursoSeleccionado", curso);
        buscarAlumno.value=""; cargarAlumnos(curso);
      });

      buscarAlumno.addEventListener('input', ()=>{
        const curso=cursoSelect.value;
        const lista=getCache(`alumnos:${curso}`)||[];
        const q=buscarAlumno.value.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
        const filtrados=!q?lista:lista.filter(n=>{
          const f=n.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
          return q.split(/\s+/).every(tok=>f.includes(tok));
        });
        pintarAlumnos(filtrados);
      });

      alumnoSelect.addEventListener('change', ()=>{
        const alumno=alumnoSelect.value;
        if(alumno && alumno!=='Selecciona un estudiante'){
          const encoded=encodeURIComponent(alumno);
          setRepartoHabilitado(true);
          btnAleatoria.href=`panel_profesor/reparto_carta_aleatoria.html?alumno=${encoded}&usuario=${encodeURIComponent(usuario)}`;
          btnEspecifica.href=`panel_profesor/reparto_carta_especifica.html?alumno=${encoded}&usuario=${encodeURIComponent(usuario)}`;
          showOnomato(alumnoSelect,'¬°POW!','ok'); showBubble(alumnoSelect,`üéì ${alumno} seleccionado. Acciones habilitadas.`,'ok');
        }else{
          setRepartoHabilitado(false);
        }
      });

      function warnIfDisabled(e, innerBtn){
        if(innerBtn.disabled){
          e.preventDefault();
          showOnomato(innerBtn,'¬°HEY!','error');
          showBubble(innerBtn,'Selecciona un estudiante primero.','warn');
        }
      }
      btnAleatoria.addEventListener('click', (e)=>warnIfDisabled(e,btnAleatoriaInner));
      btnEspecifica.addEventListener('click', (e)=>warnIfDisabled(e,btnEspecificaInner));

      const ultimo = localStorage.getItem("cursoSeleccionado");
      if(ultimo){ cursoSelect.value=ultimo; if(cursoSelect.value===ultimo) cargarAlumnos(ultimo); }
    });
  </script>

  <!-- SW -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js?v=ui3');
      });
    }
  </script>
</body>
</html>
